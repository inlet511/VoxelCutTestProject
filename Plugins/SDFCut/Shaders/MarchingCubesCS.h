
#include "/Engine/Public/Platform.ush"
#include "/Engine/Public/ShaderCommon.ush"

// Marching Cubes标准边表和三角表
static const int EdgeIndices[12][2] = {
    {0,1}, {1,2}, {2,3}, {3,0}, {4,5}, {5,6}, {6,7}, {7,4},
    {0,4}, {1,5}, {2,6}, {3,7}
};

static const int EdgeTable[256] = {
    0x000,0x009,0x012,0x01B,0x024,0x02D,0x036,0x03F,0x048,0x041,0x05A,0x053,0x06C,0x065,0x07E,0x077,
    0x080,0x089,0x092,0x09B,0x0A4,0x0AD,0x0B6,0x0BF,0x0C8,0x0C1,0x0DA,0x0D3,0x0EC,0x0E5,0x0FE,0x0F7,
    0x100,0x109,0x112,0x11B,0x124,0x12D,0x136,0x13F,0x148,0x141,0x15A,0x153,0x16C,0x165,0x17E,0x177,
    0x180,0x189,0x192,0x19B,0x1A4,0x1AD,0x1B6,0x1BF,0x1C8,0x1C1,0x1DA,0x1D3,0x1EC,0x1E5,0x1FE,0x1F7,
    0x200,0x209,0x212,0x21B,0x224,0x22D,0x236,0x23F,0x248,0x241,0x25A,0x253,0x26C,0x265,0x27E,0x277,
    0x280,0x289,0x292,0x29B,0x2A4,0x2AD,0x2B6,0x2BF,0x2C8,0x2C1,0x2DA,0x2D3,0x2EC,0x2E5,0x2FE,0x2F7,
    0x300,0x309,0x312,0x31B,0x324,0x32D,0x336,0x33F,0x348,0x341,0x35A,0x353,0x36C,0x365,0x37E,0x377,
    0x380,0x389,0x392,0x39B,0x3A4,0x3AD,0x3B6,0x3BF,0x3C8,0x3C1,0x3DA,0x3D3,0x3EC,0x3E5,0x3FE,0x3F7,
    0x400,0x409,0x412,0x41B,0x424,0x42D,0x436,0x43F,0x448,0x441,0x45A,0x453,0x46C,0x465,0x47E,0x477,
    0x480,0x489,0x492,0x49B,0x4A4,0x4AD,0x4B6,0x4BF,0x4C8,0x4C1,0x4DA,0x4D3,0x4EC,0x4E5,0x4FE,0x4F7,
    0x500,0x509,0x512,0x51B,0x524,0x52D,0x536,0x53F,0x548,0x541,0x55A,0x553,0x56C,0x565,0x57E,0x577,
    0x580,0x589,0x592,0x59B,0x5A4,0x5AD,0x5B6,0x5BF,0x5C8,0x5C1,0x5DA,0x5D3,0x5EC,0x5E5,0x5FE,0x5F7,
    0x600,0x609,0x612,0x61B,0x624,0x62D,0x636,0x63F,0x648,0x641,0x65A,0x653,0x66C,0x665,0x67E,0x677,
    0x680,0x689,0x692,0x69B,0x6A4,0x6AD,0x6B6,0x6BF,0x6C8,0x6C1,0x6DA,0x6D3,0x6EC,0x6E5,0x6FE,0x6F7,
    0x700,0x709,0x712,0x71B,0x724,0x72D,0x736,0x73F,0x748,0x741,0x75A,0x753,0x76C,0x765,0x77E,0x777,
    0x780,0x789,0x792,0x79B,0x7A4,0x7AD,0x7B6,0x7BF,0x7C8,0x7C1,0x7DA,0x7D3,0x7EC,0x7E5,0x7FE,0x7F7
};

static const int TriTable[256][16] = {
    {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,8,3,1,9,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,10,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {2,8,3,2,10,8,0,1,9,-1,-1,-1,-1,-1,-1,-1},
    {2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,2,11,1,9,8,3,8,11,-1,-1,-1,-1,-1,-1,-1},
    {1,10,11,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,10,11,2,3,11,-1,-1,-1,-1,-1,-1,-1},
    {0,10,11,0,1,9,2,3,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,10,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,4,7,1,9,8,3,8,4,-1,-1,-1,-1,-1,-1,-1},
    {1,2,10,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1},
    {0,2,10,0,1,9,4,8,7,-1,-1,-1,-1,-1,-1,-1},
    {2,4,7,2,10,8,0,1,9,3,8,4,-1,-1,-1,-1},
    {2,3,11,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,4,7,3,4,8,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,3,11,4,8,7,-1,-1,-1,-1,-1,-1,-1},
    {1,2,11,1,9,4,3,4,11,7,4,9,-1,-1,-1,-1},
    {1,10,11,2,3,11,4,8,7,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,10,11,2,3,11,-1,-1,-1,-1},
    {0,10,11,0,1,9,2,3,11,4,8,7,-1,-1,-1,-1},
    {0,1,9,2,10,11,4,8,7,-1,-1,-1,-1,-1,-1,-1},
    {4,9,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,4,9,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,0,4,5,1,8,4,-1,-1,-1,-1,-1,-1,-1},
    {1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1},
    {0,2,10,0,4,5,1,4,9,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,2,8,3,2,10,8,1,4,10,-1,-1,-1,-1},
    {2,3,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,8,3,4,9,5,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,0,1,9,2,3,11,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,1,2,11,3,8,4,11,8,9,-1,-1,-1,-1},
    {1,10,11,2,3,11,4,9,5,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,10,11,2,3,11,4,9,5,-1,-1,-1,-1},
    {0,4,5,0,1,9,1,10,11,2,3,11,-1,-1,-1,-1},
    {0,4,5,2,10,11,1,4,10,-1,-1,-1,-1,-1,-1,-1},
    {4,5,6,8,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,6,0,8,3,6,8,7,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,4,5,6,7,8,6,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,1,4,6,3,8,4,6,8,7,-1,-1,-1,-1},
    {1,2,10,4,5,6,7,8,6,-1,-1,-1,-1,-1,-1,-1},
    {0,4,6,0,8,3,1,2,10,6,8,7,-1,-1,-1,-1},
    {0,2,10,0,1,9,4,5,6,7,8,6,-1,-1,-1,-1},
    {0,1,9,2,10,4,3,8,7,4,8,10,5,6,4,-1},
    {2,3,11,4,5,6,7,8,6,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,4,6,3,4,8,6,8,7,-1,-1,-1,-1},
    {0,1,9,2,3,11,4,5,6,7,8,6,-1,-1,-1,-1},
    {1,2,11,1,9,4,3,7,8,4,7,6,5,6,4,-1},
    {1,10,11,2,3,11,4,5,6,7,8,6,-1,-1,-1,-1},
    {0,4,6,0,8,3,1,10,11,2,3,11,6,8,7,-1},
    {0,1,9,1,10,11,2,3,11,4,5,6,7,8,6,-1},
    {0,1,9,2,10,4,4,5,6,7,8,6,3,8,7,-1},
    {5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,8,3,1,9,8,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {1,5,10,2,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,5,10,2,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,5,10,0,1,9,2,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,6,10,3,8,1,-1,-1,-1,-1,-1,-1,-1},
    {2,3,11,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,8,3,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,3,11,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {1,2,11,1,9,8,3,8,11,5,6,10,-1,-1,-1,-1},
    {2,3,11,1,5,10,2,5,11,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,2,3,11,1,5,10,2,5,11,-1,-1,-1,-1},
    {0,1,9,2,3,11,0,5,10,2,5,11,-1,-1,-1,-1},
    {0,1,9,2,5,11,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {4,8,7,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,4,8,7,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {1,4,7,1,9,8,3,8,4,5,6,10,-1,-1,-1,-1},
    {1,5,10,2,6,10,4,8,7,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,5,10,2,6,10,-1,-1,-1,-1},
    {0,5,10,0,1,9,4,8,7,2,6,10,-1,-1,-1,-1},
    {0,1,9,2,6,10,3,8,7,4,8,2,5,10,2,-1},
    {2,3,11,4,8,7,5,6,10,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,4,7,3,4,8,5,6,10,-1,-1,-1,-1},
    {0,1,9,2,3,11,4,8,7,5,6,10,-1,-1,-1,-1},
    {1,2,11,1,9,4,3,7,8,4,7,6,5,6,4,10},
    {2,3,11,1,5,10,2,5,11,4,8,7,-1,-1,-1,-1},
    {0,4,7,0,8,3,2,3,11,1,5,10,2,5,11,-1},
    {0,1,9,2,3,11,0,5,10,2,5,11,4,8,7,-1},
    {0,1,9,2,5,11,4,8,7,5,6,10,3,8,2,-1},
    {5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {1,8,3,1,9,8,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {1,2,10,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,2,10,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,2,10,0,1,9,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {2,8,3,2,10,8,0,1,9,5,7,11,-1,-1,-1,-1},
    {2,5,11,3,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,2,5,0,8,3,3,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,2,5,11,3,7,11,-1,-1,-1,-1,-1,-1,-1},
    {1,2,5,1,9,8,3,8,7,11,7,5,-1,-1,-1,-1},
    {1,10,5,2,5,11,3,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,10,5,2,5,11,3,7,11,-1,-1,-1,-1},
    {0,1,9,0,10,5,2,5,11,3,7,11,-1,-1,-1,-1},
    {0,1,9,1,10,5,5,11,7,3,7,11,-1,-1,-1,-1},
    {4,8,5,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,0,8,3,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,4,8,0,1,9,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,0,4,5,3,8,4,5,7,11,-1,-1,-1,-1},
    {1,2,10,4,8,5,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,4,5,0,8,3,1,2,10,5,7,11,-1,-1,-1,-1},
    {0,2,10,0,1,9,4,8,5,5,7,11,-1,-1,-1,-1},
    {0,1,9,2,10,4,3,8,4,4,5,10,5,7,11,-1},
    {2,5,11,3,7,11,4,8,5,-1,-1,-1,-1,-1,-1,-1},
    {0,2,5,0,4,5,3,7,11,8,3,4,-1,-1,-1,-1},
    {0,1,9,2,5,11,3,7,11,4,8,5,-1,-1,-1,-1},
    {0,4,5,1,2,5,3,7,4,7,8,3,9,1,4,-1},
    {1,10,5,2,5,11,3,7,11,4,8,5,-1,-1,-1,-1},
    {0,4,5,0,8,3,1,10,5,2,5,11,3,7,11,-1},
    {0,1,9,0,4,5,1,10,5,2,5,11,3,7,11,-1},
    {0,1,9,1,10,5,4,5,8,3,8,7,5,7,11,-1},
    {4,6,7,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,4,6,7,5,7,11,-1,-1,-1,-1},
    {0,1,9,4,6,7,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {1,4,7,1,9,8,3,8,4,4,6,7,5,7,11,-1},
    {1,2,10,4,6,7,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,2,10,4,6,7,5,7,11,-1},
    {0,2,10,0,1,9,4,6,7,5,7,11,-1,-1,-1,-1},
    {0,1,9,2,10,4,3,8,7,4,8,10,4,6,7,5,11,7},
    {2,5,11,3,7,11,4,6,7,-1,-1,-1,-1,-1,-1,-1},
    {0,2,5,0,4,7,3,7,11,4,6,7,-1,-1,-1,-1},
    {0,1,9,2,5,11,3,7,11,4,6,7,-1,-1,-1,-1},
    {1,2,5,1,9,4,3,7,4,4,6,7,5,11,7,-1},
    {1,10,5,2,5,11,3,7,11,4,6,7,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,10,5,2,5,11,3,7,11,4,6,7},
    {0,1,9,1,10,5,2,5,11,3,7,11,4,6,7,-1},
    {0,1,9,1,10,5,4,6,7,5,7,11,3,8,7,0,8,3},
    {4,5,6,5,7,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,4,5,6,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,4,5,6,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {1,8,3,1,9,8,4,5,6,5,7,11,-1,-1,-1,-1},
    {1,5,6,2,6,10,5,7,11,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,5,6,2,6,10,5,7,11,-1,-1,-1,-1},
    {0,5,6,0,1,9,2,6,10,5,7,11,-1,-1,-1,-1},
    {0,1,9,2,6,10,3,8,1,5,7,11,4,5,6,-1},
    {2,5,11,3,7,11,4,5,6,-1,-1,-1,-1,-1,-1,-1},
    {0,2,5,0,8,3,3,7,11,4,5,6,-1,-1,-1,-1},
    {0,1,9,2,5,11,3,7,11,4,5,6,-1,-1,-1,-1},
    {1,2,5,1,9,8,3,8,7,4,5,6,11,7,5,-1},
    {1,6,10,2,5,11,3,7,11,4,5,6,-1,-1,-1,-1},
    {0,8,3,1,6,10,2,5,11,3,7,11,4,5,6,-1},
    {0,1,9,0,6,10,2,5,11,3,7,11,4,5,6,-1},
    {0,1,9,1,6,10,4,5,6,5,7,11,3,8,7,0,8,3},
    {4,5,7,6,7,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,4,5,7,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,1,9,4,5,7,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {1,8,3,1,9,8,4,5,7,6,7,10,-1,-1,-1,-1},
    {1,2,10,4,5,7,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,8,3,1,2,10,4,5,7,6,7,10,-1,-1,-1,-1},
    {0,2,10,0,1,9,4,5,7,6,7,10,-1,-1,-1,-1},
    {2,8,3,2,10,8,0,1,9,4,5,7,6,7,10,-1},
    {2,3,11,4,5,7,6,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,2,11,0,8,3,4,5,7,6,7,10,-1,-1,-1,-1},
    {0,1,9,2,3,11,4,5,7,6,7,10,-1,-1,-1,-1},
    {1,2,11,1,9,8,3,8,11,4,5,7,6,7,10,-1},
    {1,4,7,2,3,11,5,7,10,6,10,2,-1,-1,-1,-1},
    {0,8,3,1,4,7,2,3,11,5,7,10,6,10,2,-1},
    {0,1,9,0,4,7,2,3,11,5,7,10,6,10,2,-1},
    {0,1,9,2,10,6,3,8,1,4,5,7,7,10,5,-1},
    {4,8,7,5,7,10,6,10,2,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,5,7,10,6,10,2,-1,-1,-1,-1},
    {0,1,9,4,8,7,5,7,10,6,10,2,-1,-1,-1,-1},
    {1,4,7,1,9,8,3,8,4,5,7,10,6,10,2,-1},
    {1,2,6,4,8,7,5,7,10,-1,-1,-1,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,2,6,5,7,10,-1,-1,-1,-1},
    {0,2,6,0,1,9,4,8,7,5,7,10,-1,-1,-1,-1},
    {0,1,9,2,6,4,3,8,7,4,8,2,5,7,10,-1},
    {2,3,11,4,8,7,5,7,10,6,10,2,-1,-1,-1,-1},
    {0,2,11,0,4,7,3,4,8,5,7,10,6,10,2,-1},
    {0,1,9,2,3,11,4,8,7,5,7,10,6,10,2,-1},
    {1,2,11,1,9,4,3,7,8,4,7,5,5,10,7,6,2,10},
    {1,4,7,2,3,11,5,7,10,6,2,10,-1,-1,-1,-1},
    {0,4,7,0,8,3,1,4,7,2,3,11,5,10,7,6,2,10},
    {0,1,9,0,4,7,2,3,11,5,10,7,6,2,10,-1},
    {0,1,9,2,10,6,3,8,7,4,8,2,4,7,5,5,10,7}
};

// 采样动态SDF
float SampleDynamicSDF(RWTexture3D<float> DynamicSDF, float3 WorldPos, FAxisAlignedBox Bounds, FIntVector Dimensions)
{
    float3 UV = (WorldPos - Bounds.Min) / (Bounds.Max - Bounds.Min);
    int3 VoxelIndex = int3(saturate(UV) * Dimensions);
    return DynamicSDF[VoxelIndex];
}

// 计算体素8个角点的SDF值
void SampleCubeSDF(RWTexture3D<float> DynamicSDF, float3 CubePos, float CubeSize, FAxisAlignedBox Bounds, FIntVector Dimensions, out float Values[8])
{
    float3 HalfSize = float3(CubeSize * 0.5f, CubeSize * 0.5f, CubeSize * 0.5f);
    Values[0] = SampleDynamicSDF(DynamicSDF, CubePos + float3(-HalfSize.x, -HalfSize.y, -HalfSize.z), Bounds, Dimensions);
    Values[1] = SampleDynamicSDF(DynamicSDF, CubePos + float3(HalfSize.x, -HalfSize.y, -HalfSize.z), Bounds, Dimensions);
    Values[2] = SampleDynamicSDF(DynamicSDF, CubePos + float3(HalfSize.x, HalfSize.y, -HalfSize.z), Bounds, Dimensions);
    Values[3] = SampleDynamicSDF(DynamicSDF, CubePos + float3(-HalfSize.x, HalfSize.y, -HalfSize.z), Bounds, Dimensions);
    Values[4] = SampleDynamicSDF(DynamicSDF, CubePos + float3(-HalfSize.x, -HalfSize.y, HalfSize.z), Bounds, Dimensions);
    Values[5] = SampleDynamicSDF(DynamicSDF, CubePos + float3(HalfSize.x, -HalfSize.y, HalfSize.z), Bounds, Dimensions);
    Values[6] = SampleDynamicSDF(DynamicSDF, CubePos + float3(HalfSize.x, HalfSize.y, HalfSize.z), Bounds, Dimensions);
    Values[7] = SampleDynamicSDF(DynamicSDF, CubePos + float3(-HalfSize.x, HalfSize.y, HalfSize.z), Bounds, Dimensions);
}

// 计算边的交点
float3 ComputeEdgeIntersection(float3 p0, float f0, float3 p1, float f1, float IsoValue)
{
    if (abs(f0 - f1) < 0.0001f) return (p0 + p1) * 0.5f;
    float t = saturate((IsoValue - f0) / (f1 - f0));
    return lerp(p0, p1, t);
}

[numthreads(8, 8, 8)]
void MarchingCubesKernel(uint3 DispatchThreadId : SV_DispatchThreadID)
{
    FIntVector CubeIndex = FIntVector(DispatchThreadId.x, DispatchThreadId.y, DispatchThreadId.z);
    
    // 超出动态SDF范围，直接返回
    if (CubeIndex.X >= DynamicSDFDimensions.X - 1 || 
        CubeIndex.Y >= DynamicSDFDimensions.Y - 1 || 
        CubeIndex.Z >= DynamicSDFDimensions.Z - 1)
    {
        return;
    }

    // 1. 计算当前立方体的中心位置
    float3 Step = (DynamicSDFBounds.Max - DynamicSDFBounds.Min) / DynamicSDFDimensions;
    float3 CubePos = DynamicSDFBounds.Min + (CubeIndex + 0.5f) * Step;

    // 2. 采样立方体8个角点的SDF值
    float SDFValues[8];
    SampleCubeSDF(DynamicSDF, CubePos, GlobalParams.CubeSize, DynamicSDFBounds, DynamicSDFDimensions, SDFValues);

    // 3. 计算立方体编码（判断每个角点是否在等值面内）
    int CubeCode = 0;
    for (int i = 0; i < 8; i++)
    {
        if (SDFValues[i] < GlobalParams.IsoValue)
        {
            CubeCode |= (1 << i);
        }
    }

    // 4. 无等值面，直接返回
    if (EdgeTable[CubeCode] == 0) return;

    // 5. 计算边交点
    float3 EdgeVertices[12];
    int EdgeVertexIndices[12];
    for (int i = 0; i < 12; i++)
    {
        if (EdgeTable[CubeCode] & (1 << i))
        {
            int A = EdgeIndices[i][0];
            int B = EdgeIndices[i][1];
            float3 P0 = CubePos + float3(
                (A & 1) ? Step.x * 0.5f : -Step.x * 0.5f,
                (A & 2) ? Step.y * 0.5f : -Step.y * 0.5f,
                (A & 4) ? Step.z * 0.5f : -Step.z * 0.5f
            );
            float3 P1 = CubePos + float3(
                (B & 1) ? Step.x * 0.5f : -Step.x * 0.5f,
                (B & 2) ? Step.y * 0.5f : -Step.y * 0.5f,
                (B & 4) ? Step.z * 0.5f : -Step.z * 0.5f
            );
            EdgeVertices[i] = ComputeEdgeIntersection(P0, SDFValues[A], P1, SDFValues[B], GlobalParams.IsoValue);
            
            // 原子操作分配顶点索引（避免并发冲突）
            EdgeVertexIndices[i] = InterlockedAdd(MCOutputParams.VertexCounter[0], 1);
            MCOutputParams.OutVertices[EdgeVertexIndices[i]] = EdgeVertices[i];
        }
    }

    // 6. 生成三角形
    for (int i = 0; TriTable[CubeCode][i] != -1; i += 3)
    {
        int Idx0 = TriTable[CubeCode][i];
        int Idx1 = TriTable[CubeCode][i + 1];
        int Idx2 = TriTable[CubeCode][i + 2];

        if (Idx0 >= 0 && Idx1 >= 0 && Idx2 >= 0)
        {
            int TriIndex = InterlockedAdd(MCOutputParams.TriangleCounter[0], 1);
            MCOutputParams.OutTriangles[TriIndex] = int3(EdgeVertexIndices[Idx0], EdgeVertexIndices[Idx1], EdgeVertexIndices[Idx2]);
        }
    }
}